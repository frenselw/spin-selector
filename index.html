<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpinSelector</title>
    <!--
    SpinSelector - A Standalone Random Name Picker Wheel
    Version: 1.1.1

    Copyright (C) 2025 Hang Wong

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            min-height: 100vh;
        }

        canvas {
            max-width: 100%;
            max-height: 85vh;
        }

        #wheel {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }

        #wheel:hover {
            transform: scale(1.02);
        }

        #confetti-canvas {
            pointer-events: none;
            z-index: 10;
        }

        #winner-name {
            font-weight: 600;
        }

        @media (min-width: 992px) {
            .controls-column {
                max-width: 350px;
            }
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100 py-4 bg-body-tertiary">
    <main class="container-fluid flex-grow-1">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">SpinSelector</h1>
            <button class="btn btn-sm btn-outline-secondary" id="about-btn">About</button>
        </header>

        <div class="row justify-content-center align-items-center">
            <div class="col-lg-8 text-center position-relative">
                <canvas id="wheel"></canvas>
                <canvas id="confetti-canvas" class="position-absolute top-0 start-0"></canvas>
            </div>
            <div class="col-lg-4 controls-column">
                <div class="mb-4">
                    <h5 class="mb-2">Entries</h5>
                    <textarea id="names" class="form-control" rows="8">Alice
Bob
Charlie
Diana
Edward
Fiona
George
Helen</textarea>
                </div>
                <div class="mb-4">
                    <h5 class="mb-2">Manage Lists</h5>
                    <div class="input-group mb-2">
                        <input type="text" id="list-name-input" class="form-control" placeholder="Current List Name">
                        <button class="btn btn-primary" id="save-list-btn">Save</button>
                    </div>
                    <div class="input-group">
                        <select class="form-select" id="saved-lists-dropdown"></select>
                        <button class="btn btn-danger" id="delete-list-btn">Delete</button>
                    </div>
                </div>
                <div>
                    <h5 class="mb-2">Actions</h5>
                    <div class="d-grid gap-2">
                        <button id="shuffle" class="btn btn-secondary">Shuffle Names</button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100" type="button"
                                data-bs-toggle="dropdown">Select Theme</button>
                            <ul class="dropdown-menu w-100" id="theme-selector">
                                <li><a class="dropdown-item" href="#" data-theme="dark">Default Dark</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="neon">Neon Nights</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="oceanic">Oceanic</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="pastel">Pastel Dream</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="forest">Forest</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="sunset">Sunset</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="grayscale">Grayscale</a></li>
                                <li><a class="dropdown-item" href="#" data-theme="light">Classic Light</a></li>
                            </ul>
                        </div>
                        <button class="btn btn-success" id="export-lists-btn">Export Lists to File</button>
                        <label for="import-file-input" class="btn btn-info">Import Lists from File</label>
                        <input type="file" id="import-file-input" class="d-none">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="winnerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Congratulations!</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="lead">The winner is...</p>
                    <h2 id="winner-name" class="display-4"></h2>
                </div>
                <div class="modal-footer border-0 justify-content-center"><button type="button"
                        class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button"
                        class="btn btn-danger" id="remove-winner-btn">Remove Winner</button></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalTitle"></h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="infoModalBody"></p>
                </div>
                <div class="modal-footer" id="infoModalFooter"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">About SpinSelector</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-body-secondary">Version 1.1.1</p>
                    <p>&copy; 2025 Hang Wong.</p>
                    <p>This software is open-source and licensed under the <a
                            href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank"
                            rel="noopener noreferrer">GNU Affero General Public License v3.0</a>.</p>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const wheelCanvas = document.getElementById('wheel');
            const ctx = wheelCanvas.getContext('2d', { willReadFrequently: false });
            const confettiCanvas = document.getElementById('confetti-canvas');
            const confettiCtx = confettiCanvas.getContext('2d', { willReadFrequently: false });

            const shuffleButton = document.getElementById('shuffle');
            const namesInput = document.getElementById('names');
            const themeSelector = document.getElementById('theme-selector');
            const listNameInput = document.getElementById('list-name-input');
            const saveListBtn = document.getElementById('save-list-btn');
            const savedListsDropdown = document.getElementById('saved-lists-dropdown');
            const deleteListBtn = document.getElementById('delete-list-btn');
            const exportListsBtn = document.getElementById('export-lists-btn');
            const importFileInput = document.getElementById('import-file-input');
            const aboutBtn = document.getElementById('about-btn');

            const winnerModal = new bootstrap.Modal(document.getElementById('winnerModal'));
            const winnerNameElement = document.getElementById('winner-name');
            const removeWinnerBtn = document.getElementById('remove-winner-btn');
            const infoModal = new bootstrap.Modal(document.getElementById('infoModal'));
            const infoModalTitle = document.getElementById('infoModalTitle');
            const infoModalBody = document.getElementById('infoModalBody');
            const infoModalFooter = document.getElementById('infoModalFooter');
            const aboutModal = new bootstrap.Modal(document.getElementById('aboutModal'));

            const themes = {
                dark: ["#0d6efd", "#854bcc", "#d63384", "#dc3545", "#fd7e14", "#ffc107", "#198754", "#20c997"],
                neon: ["#f72585", "#b5179e", "#7209b7", "#480ca8", "#3f37c9", "#4895ef", "#4cc9f0"],
                oceanic: ["#03045e", "#0077b6", "#00b4d8", "#90e0ef", "#caf0f8"],
                pastel: ["#ffadad", "#ffd6a5", "#fdffb6", "#caffbf", "#9bf6ff", "#a0c4ff", "#bdb2ff"],
                forest: ["#2d6a4f", "#40916c", "#52b788", "#74c69d", "#95d5b2"],
                sunset: ["#f94144", "#f3722c", "#f8961e", "#f9c74f", "#90be6d", "#43aa8b"],
                grayscale: ["#212529", "#495057", "#adb5bd", "#dee2e6", "#f8f9fa"],
                light: ["#0077b6", "#00b4d8", "#90e0ef", "#ff7f51", "#ffb703", "#8338ec"]
            };
            let names = [];
            let currentColors = themes.dark;
            let savedLists = {};
            let rotation = 0;
            let offscreenCanvas;
            let offscreenCtx;
            let resizeTimeout;
            let isSpinning = false;
            let spinStartTime = 0;
            let startRotation = 0;
            let totalSpinAngle = 0;
            const spinDuration = 10000;
            let lastWinnerIndex = -1;
            let confetti = [];

            const showModal = (title, body, buttons = []) => {
                infoModalTitle.textContent = title;
                infoModalBody.textContent = body;
                infoModalFooter.innerHTML = '';

                if (buttons.length === 0) {
                    const closeBtn = document.createElement('button');
                    closeBtn.type = 'button';
                    closeBtn.className = 'btn btn-secondary';
                    closeBtn.textContent = 'Close';
                    closeBtn.onclick = () => infoModal.hide();
                    infoModalFooter.appendChild(closeBtn);
                } else {
                    buttons.forEach(btnConfig => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = `btn ${btnConfig.class}`;
                        button.textContent = btnConfig.label;
                        button.onclick = () => {
                            if (btnConfig.onClick) btnConfig.onClick();
                            infoModal.hide();
                        };
                        infoModalFooter.appendChild(button);
                    });
                }
                infoModal.show();
            };

            const getDynamicFontSize = (numSegments, radius) => {
                // Modified values to make font smaller than previous version but still readable
                const maxFontSize = 50, minFontSize = 14;
                const baseSize = radius / 6.5; 
                let fontSize = baseSize - (numSegments * 0.5);
                return Math.max(minFontSize, Math.min(maxFontSize, fontSize));
            };

            const resizeCanvas = () => {
                const canvasSize = Math.min(window.innerWidth * 0.7, 800, window.innerHeight * 0.85);
                wheelCanvas.width = canvasSize;
                wheelCanvas.height = canvasSize;
                confettiCanvas.width = canvasSize;
                confettiCanvas.height = canvasSize;

                if (offscreenCanvas) {
                    offscreenCanvas.width = canvasSize;
                    offscreenCanvas.height = canvasSize;

                    const radius = canvasSize / 2;
                    const numSegments = names.length;
                    if (numSegments > 0) {
                        const fontSize = getDynamicFontSize(numSegments, radius);
                        const anglePerSegment = 2 * Math.PI / numSegments;
                        prerenderWheel(numSegments, radius, fontSize, anglePerSegment);
                    }
                }
                drawWheel();
            };

            const debounceResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 100);
            };

            window.addEventListener('resize', debounceResize);

            const prerenderWheel = (numSegments, radius, fontSize, anglePerSegment) => {
                if (numSegments === 0) {
                    offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                    return;
                }

                offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                offscreenCtx.save();
                offscreenCtx.translate(radius, radius);

                names.forEach((name, i) => {
                    const angle = i * anglePerSegment;
                    offscreenCtx.beginPath();
                    offscreenCtx.moveTo(0, 0);
                    offscreenCtx.arc(0, 0, radius - 2, angle, angle + anglePerSegment);
                    offscreenCtx.closePath();
                    offscreenCtx.fillStyle = currentColors[i % currentColors.length];
                    offscreenCtx.fill();

                    const strokeStyle = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? "#1a1a1a" : "#ffffff";
                    offscreenCtx.lineWidth = 3;
                    offscreenCtx.strokeStyle = strokeStyle;
                    offscreenCtx.stroke();

                    // Draw text rotated for each segment
                    offscreenCtx.save();
                    offscreenCtx.rotate(angle + anglePerSegment / 2);
                    offscreenCtx.fillStyle = "#fff";
                    offscreenCtx.font = `bold ${fontSize}px Arial`;
                    offscreenCtx.textAlign = "right";
                    offscreenCtx.textBaseline = "middle";
                    offscreenCtx.shadowColor = "black";
                    offscreenCtx.shadowBlur = 2;
                    const textX = Math.round(radius - 10); // Slightly more padding
                    const textY = 0;
                    offscreenCtx.fillText(name, textX, textY);
                    offscreenCtx.restore();
                });
                offscreenCtx.restore();

                ctx.imageSmoothingEnabled = false;
            };

            const updateNames = () => {
                names = namesInput.value.split('\n').filter(name => name.trim() !== '');
                const numSegments = names.length;
                if (numSegments === 0) {
                    return;
                }
                const canvasSize = Math.min(window.innerWidth * 0.7, 800, window.innerHeight * 0.85);
                const radius = canvasSize / 2;
                const fontSize = getDynamicFontSize(numSegments, radius);

                if (!offscreenCanvas || offscreenCanvas.width !== canvasSize) {
                    offscreenCanvas = document.createElement('canvas');
                    offscreenCtx = offscreenCanvas.getContext('2d', { willReadFrequently: false });
                }
                offscreenCanvas.width = canvasSize;
                offscreenCanvas.height = canvasSize;

                const anglePerSegment = 2 * Math.PI / numSegments;
                prerenderWheel(numSegments, radius, fontSize, anglePerSegment);
                drawWheel();
            };

            const shuffleNames = () => {
                for (let i = names.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [names[i], names[j]] = [names[j], names[i]];
                }
                namesInput.value = names.join('\n');
                updateNames();
            };

            const drawWheel = () => {
                const numSegments = names.length;
                if (numSegments === 0) {
                    ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
                    return;
                }

                const canvasSize = Math.min(window.innerWidth * 0.7, 800, window.innerHeight * 0.85);
                wheelCanvas.width = canvasSize;
                wheelCanvas.height = canvasSize;
                confettiCanvas.width = canvasSize;
                confettiCanvas.height = canvasSize;

                const radius = wheelCanvas.width / 2;

                // Draw pre-rendered wheel with rotation
                ctx.clearRect(0, 0, wheelCanvas.width, wheelCanvas.height);
                ctx.save();
                ctx.translate(radius, radius);
                ctx.rotate(rotation);
                ctx.drawImage(offscreenCanvas, -radius, -radius);
                ctx.restore();

                // Draw pointer (static)
                ctx.fillStyle = "#adb5bd";
                ctx.beginPath();
                ctx.moveTo(radius - 15, 5);
                ctx.lineTo(radius + 15, 5);
                ctx.lineTo(radius, 45);
                ctx.closePath();
                ctx.fill();
                ctx.strokeStyle = "black";
                ctx.lineWidth = 1;
                ctx.stroke();
            };

            const announceWinner = () => {
                const anglePerSegment = 360 / names.length;
                const totalDegrees = rotation * 180 / Math.PI;
                const effectiveAngle = (270 - totalDegrees) % 360;
                const normalizedAngle = (effectiveAngle + 360) % 360;
                lastWinnerIndex = Math.floor(normalizedAngle / anglePerSegment);
                winnerNameElement.textContent = names[lastWinnerIndex];
                winnerModal.show(); launchConfetti();
            };
            const easeInOutQuint = (t) => t < 0.5 ? 16 * t * t * t * t * t : 1 - Math.pow(-2 * t + 2, 5) / 2;
            const animate = () => {
                if (isSpinning) {
                    const elapsedTime = Date.now() - spinStartTime;
                    if (elapsedTime >= spinDuration) {
                        isSpinning = false;
                        rotation = startRotation + totalSpinAngle;
                        drawWheel();
                        announceWinner();
                    } else {
                        const progress = elapsedTime / spinDuration;
                        const easedProgress = easeInOutQuint(progress);
                        rotation = startRotation + totalSpinAngle * easedProgress;
                        drawWheel();
                    }
                } else {
                    // Subtle idle rotation only when not spinning
                    rotation += 0.0005;
                    drawWheel();
                }
                updateConfetti();
                requestAnimationFrame(animate);
            };
            const startSpin = () => {
                if (isSpinning || names.length <= 1) return;
                isSpinning = true;
                spinStartTime = Date.now();
                startRotation = rotation;
                const randomRotations = Math.floor(Math.random() * 10) + 15;
                const randomFinalAngle = Math.random() * 2 * Math.PI;
                totalSpinAngle = (randomRotations * 2 * Math.PI) + randomFinalAngle;
            };
            const handleRemoveWinner = () => {
                if (lastWinnerIndex > -1) {
                    names.splice(lastWinnerIndex, 1);
                    namesInput.value = names.join('\n');
                    lastWinnerIndex = -1;
                    updateNames();
                }
                winnerModal.hide();
            };

            const updateListsDropdown = () => {
                const selectedValue = savedListsDropdown.value;
                savedListsDropdown.innerHTML = '<option selected disabled>Load a saved list...</option>';
                for (const listName in savedLists) {
                    const option = document.createElement('option');
                    option.value = listName; option.textContent = listName;
                    savedListsDropdown.appendChild(option);
                } savedListsDropdown.value = selectedValue;
            };
            const saveListsToStorage = () => localStorage.setItem('spinSelectorLists', JSON.stringify(savedLists));
            const loadListsFromStorage = () => {
                const listsJSON = localStorage.getItem('spinSelectorLists');
                savedLists = listsJSON ? JSON.parse(listsJSON) : {};
                updateListsDropdown();
            };
            const handleSaveList = () => {
                const listName = listNameInput.value.trim();
                if (!listName) {
                    showModal('Save Error', 'Please enter a name for the list.');
                    return;
                }
                const namesToSave = namesInput.value;
                savedLists[listName] = namesToSave;
                saveListsToStorage(); updateListsDropdown();
                savedListsDropdown.value = listName;
                showModal('Success', `List "${listName}" saved!`);
            };
            const handleLoadList = () => {
                const listName = savedListsDropdown.value;
                if (savedLists[listName]) {
                    namesInput.value = savedLists[listName];
                    listNameInput.value = listName;
                    updateNames();
                }
            };
            const handleDeleteList = () => {
                const listName = savedListsDropdown.value;
                if (savedLists[listName]) {
                    showModal('Confirm Deletion', `Are you sure you want to delete the list "${listName}"?`, [
                        {
                            label: 'Cancel',
                            class: 'btn-secondary'
                        },
                        {
                            label: 'Delete',
                            class: 'btn-danger',
                            onClick: () => {
                                delete savedLists[listName];
                                saveListsToStorage();
                                updateListsDropdown();
                                listNameInput.value = '';
                                showModal('Deleted', `List "${listName}" has been deleted.`);
                            }
                        }
                    ]);
                } else {
                    showModal('Delete Error', 'Please select a list to delete.');
                }
            };

            const handleExport = () => {
                if (Object.keys(savedLists).length === 0) {
                    showModal('Export Error', 'There are no saved lists to export.');
                    return;
                }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(savedLists));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "spinselector_lists.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return; const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedLists = JSON.parse(e.target.result);
                        savedLists = { ...savedLists, ...importedLists };
                        saveListsToStorage(); updateListsDropdown();
                        showModal('Success', 'Lists imported successfully!');
                    } catch (error) {
                        showModal('Import Error', 'Could not import file. Please ensure it is a valid JSON file.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const handleThemeChange = (e) => {
                e.preventDefault();
                const themeName = e.target.dataset.theme;
                if (themes[themeName]) {
                    currentColors = themes[themeName];
                    document.documentElement.setAttribute('data-bs-theme', themeName === 'light' ? 'light' : 'dark');
                    updateNames(); // Trigger pre-render on theme change
                }
            };

            function launchConfetti() {
                confetti = [];
                const count = 200;
                for (let i = 0; i < count; i++) {
                    confetti.push({
                        x: confettiCanvas.width / 2,
                        y: confettiCanvas.height / 2,
                        color: currentColors[Math.floor(Math.random() * currentColors.length)],
                        size: Math.random() * 5 + 2,
                        speed: Math.random() * 10 + 5,
                        angle: Math.random() * Math.PI * 2, life: 1,
                    });
                }
            }
            function updateConfetti() {
                confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
                for (let i = confetti.length - 1; i >= 0; i--) {
                    const p = confetti[i];
                    p.x += Math.cos(p.angle) * p.speed;
                    p.y += Math.sin(p.angle) * p.speed;
                    p.life -= 0.02; p.speed *= 0.98;
                    if (p.life <= 0) {
                        confetti.splice(i, 1);
                    } else {
                        confettiCtx.beginPath();
                        confettiCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        confettiCtx.fillStyle = p.color;
                        confettiCtx.globalAlpha = p.life;
                        confettiCtx.fill();
                    }
                } confettiCtx.globalAlpha = 1;
            }

            namesInput.addEventListener('input', updateNames);
            shuffleButton.addEventListener('click', shuffleNames);
            wheelCanvas.addEventListener('click', startSpin);
            removeWinnerBtn.addEventListener('click', handleRemoveWinner);
            themeSelector.addEventListener('click', handleThemeChange);
            saveListBtn.addEventListener('click', handleSaveList);
            savedListsDropdown.addEventListener('change', handleLoadList);
            deleteListBtn.addEventListener('click', handleDeleteList);
            exportListsBtn.addEventListener('click', handleExport);
            importFileInput.addEventListener('change', handleImport);
            aboutBtn.addEventListener('click', () => aboutModal.show());

            loadListsFromStorage();
            updateNames();
            animate();
        });
    </script>
</body>

</html>